#!/bin/bash
# Link all java source files listed in SRCFILES to a single directory
# so that they can be easily located from stack traces in compilation mode,
# where only package names (not full paths) are displayed.
set -e

if [[ -z "$ZK_PROJECT_ROOT" ]]; then
    echo "ZK_PROJECT_ROOT is not set"
    exit 1
fi

cd "$ZK_PROJECT_ROOT"

last_update_timestamp=0

TIMESTAMP_FILE='SRCFILES_JAVA_LINKS/.timestamp'
if [[ -e "$TIMESTAMP_FILE" ]]; then
    last_update_timestamp=$(stat -f '%m' "$TIMESTAMP_FILE")
else
    mkdir -p SRCFILES_JAVA_LINKS
fi

touch -a -m "$TIMESTAMP_FILE"

echo -n "Linking java files to SRCFILES_JAVA_LINKS ..."
grep '\.java$' SRCFILES | while read file; do
    file_timestamp=$(stat -f '%m' "$file")
    if [[ "$file_timestamp" -gt "$last_update_timestamp" ]]; then
        dest=$(grep '^package .*;' "$file" | sed -e 's/^package //g' -e 's/;$//g' -e 's/\./\//g')
        dest="SRCFILES_JAVA_LINKS/$dest"
        if [[ -n "$dest" ]]; then
            mkdir -p "$dest"
            if [[ -n "$ZK_DEBUG" ]]; then
                echo ln -sf "$file" "$dest"
            fi
            ln -sf "$file" "$dest"
        fi
    fi
done
echo Done
